<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Nutrition API Manager</title>
    <style>
        /* Keep your existing styles and add these new ones */
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e5e7;
            margin-bottom: 24px;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #86868b;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }
        
        .tab:hover {
            color: #007aff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: #f7f7f9;
            border-radius: 8px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f7f7f9;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .current-page {
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 6px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .comparison-table th {
            background: #f7f7f9;
            font-weight: 600;
        }
        
        .comparison-table tr:hover {
            background: #f9f9f9;
        }
        
        .selected-foods {
            background: #e8f4fd;
            border: 1px solid #007aff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .selected-food-item {
            display: inline-block;
            background: #007aff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
        }
        
        .remove-food {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .data-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .badge-foundation { background: #d1eddb; color: #0f5132; }
        .badge-branded { background: #fff3cd; color: #664d03; }
        .badge-sr-legacy { background: #d1ecf1; color: #055160; }
        .badge-survey { background: #f8d7da; color: #721c24; }
        .badge-experimental { background: #e2e3e5; color: #41464b; }
        
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            flex: 1;
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e5e7;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #007aff;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #86868b;
        }
        
        /* Food item separation styles */
        .food-item {
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .food-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #007aff;
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .food-item:hover .food-name {
            color: #007aff;
        }
        
        .food-item:not(:last-child) {
            border-bottom: 2px solid #f0f0f0;
        }
        
        .food-separator {
            height: 1px;
            background: linear-gradient(to right, transparent, #d1d1d6, transparent);
            margin: 12px 0;
        }
        
        .click-hint {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }
        
        .food-item:hover .click-hint {
            opacity: 1;
        }
        
        .food-name {
            font-weight: 600;
            margin-bottom: 8px;
            transition: color 0.2s ease;
        }
        
        .nutrient-highlight {
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            color: #007aff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçé Enhanced Nutrition API Manager</h1>
            <p>Advanced nutrition data management with comprehensive API support</p>
        </div>

        <!-- Enhanced API Provider Section -->
        <div class="card">
            <h2>Enhanced API Providers</h2>
            <div class="form-group">
                <label for="enhanced-api-key">Enhanced USDA API Key</label>
                <input type="password" id="enhanced-api-key" class="form-control" placeholder="Enter your USDA API key">
            </div>
            <button onclick="addEnhancedProvider()" class="btn">Add Enhanced Provider</button>
            <button onclick="loadDataTypes()" class="btn btn-secondary">Load Data Types</button>
        </div>

        <!-- Tabbed Interface -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">Advanced Search</button>
                <button class="tab" onclick="switchTab('browse')">Browse Foods</button>
                <button class="tab" onclick="switchTab('compare')">Compare Foods</button>
                <button class="tab" onclick="switchTab('analytics')">Analytics</button>
            </div>

            <!-- Advanced Search Tab -->
            <div id="search-tab" class="tab-content active">
                <h3>Advanced Food Search</h3>
                <div class="filter-group">
                    <div class="form-group">
                        <label for="adv-search-query">Search Query</label>
                        <input type="text" id="adv-search-query" class="form-control" placeholder="e.g., chicken breast, organic milk">
                    </div>
                    <div class="form-group">
                        <label for="brand-owner">Brand Owner (Optional)</label>
                        <input type="text" id="brand-owner" class="form-control" placeholder="e.g., General Mills">
                    </div>
                    <div class="form-group">
                        <label for="sort-by">Sort By</label>
                        <select id="sort-by" class="form-control">
                            <option value="relevance">Relevance (Default)</option>
                            <option value="description">Description</option>
                            <option value="dataType">Data Type</option>
                            <option value="fdcId">FDC ID</option>
                            <option value="publishedDate">Published Date</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sort-order">Sort Order</label>
                        <select id="sort-order" class="form-control">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h4 style="margin: 0 0 12px 0; color: #007aff;">Secondary Sorting (Client-Side)</h4>
                    <div class="form-group">
                        <label for="nutrient-sort">Sort by Nutrient</label>
                        <select id="nutrient-sort" class="form-control" onchange="reorderResultsByNutrient()">
                            <option value="">No Nutrient Sorting</option>
                            <option value="calories">Calories (Energy)</option>
                            <option value="protein">Protein (g)</option>
                            <option value="carbs">Carbohydrates (g)</option>
                            <option value="fat">Total Fat (g)</option>
                            <option value="sodium">Sodium (mg)</option>
                            <option value="fiber">Fiber (g)</option>
                            <option value="sugar">Sugar (g)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nutrient-sort-order">Nutrient Sort Order</label>
                        <select id="nutrient-sort-order" class="form-control" onchange="reorderResultsByNutrient()">
                            <option value="desc">Highest First</option>
                            <option value="asc">Lowest First</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Data Types to Include</label>
                    <div id="data-types-checkboxes" class="checkbox-group">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <button onclick="performAdvancedSearch()" class="btn">Advanced Search</button>
                <button onclick="clearAdvancedSearch()" class="btn btn-secondary">Clear Filters</button>
                
                <div id="search-stats" class="stats-row" style="display: none;">
                    <div class="stat-card">
                        <div id="total-results" class="stat-value">0</div>
                        <div class="stat-label">Total Results</div>
                    </div>
                    <div class="stat-card">
                        <div id="current-page-stat" class="stat-value">1</div>
                        <div class="stat-label">Current Page</div>
                    </div>
                    <div class="stat-card">
                        <div id="total-pages" class="stat-value">1</div>
                        <div class="stat-label">Total Pages</div>
                    </div>
                </div>
                
                <div id="search-pagination" class="pagination" style="display: none;"></div>
                <div id="advanced-search-results" class="search-results" style="display: none;"></div>
            </div>

            <!-- Browse Foods Tab -->
            <div id="browse-tab" class="tab-content">
                <h3>Browse Foods by Category</h3>
                <div class="filter-group">
                    <div class="form-group">
                        <label>Select Food Categories</label>
                        <div id="browse-data-types" class="checkbox-group">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="browse-page-size">Items per Page</label>
                        <select id="browse-page-size" class="form-control">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="browseFoods()" class="btn">Browse Foods</button>
                <button onclick="loadRandomSample()" class="btn btn-secondary">Random Sample</button>
                
                <div id="browse-pagination" class="pagination" style="display: none;"></div>
                <div id="browse-results" class="search-results" style="display: none;"></div>
            </div>

            <!-- Compare Foods Tab -->
            <div id="compare-tab" class="tab-content">
                <h3>Compare Foods</h3>
                <p>Select foods from search results to compare their nutritional profiles side by side.</p>
                
                <div id="selected-foods-display" class="selected-foods" style="display: none;">
                    <strong>Selected Foods for Comparison:</strong>
                    <div id="selected-foods-list"></div>
                    <button onclick="performComparison()" class="btn">Compare Selected Foods</button>
                    <button onclick="clearSelectedFoods()" class="btn btn-secondary">Clear Selection</button>
                </div>
                
                <div class="form-group">
                    <label for="compare-fdc-ids">Or enter FDC IDs directly (comma-separated)</label>
                    <input type="text" id="compare-fdc-ids" class="form-control" placeholder="e.g., 170148,170149,170150">
                    <button onclick="compareByIds()" class="btn" style="margin-top: 8px;">Compare by IDs</button>
                </div>
                
                <div id="comparison-results" style="display: none;">
                    <h4>Nutritional Comparison</h4>
                    <div id="comparison-table-container"></div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <h3>Database Analytics</h3>
                <p>Get insights into the USDA FoodData Central database.</p>
                
                <div class="stats-row">
                    <div class="stat-card">
                        <div id="foundation-count" class="stat-value">-</div>
                        <div class="stat-label">Foundation Foods</div>
                    </div>
                    <div class="stat-card">
                        <div id="branded-count" class="stat-value">-</div>
                        <div class="stat-label">Branded Foods</div>
                    </div>
                    <div class="stat-card">
                        <div id="sr-legacy-count" class="stat-value">-</div>
                        <div class="stat-label">SR Legacy</div>
                    </div>
                    <div class="stat-card">
                        <div id="survey-count" class="stat-value">-</div>
                        <div class="stat-label">Survey Foods</div>
                    </div>
                </div>
                
                <button onclick="generateAnalytics()" class="btn">Generate Analytics</button>
                <button onclick="exportData()" class="btn btn-secondary">Export Sample Data</button>
            </div>
        </div>

        <!-- Alerts area -->
        <div id="alerts"></div>
    </div>

    <script>
        // Global variables
        let currentDataTypes = [];
        let selectedFoodsForComparison = [];
        let currentSearchResults = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadDataTypes();
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Enhanced provider management
        async function addEnhancedProvider() {
            const apiKey = document.getElementById('enhanced-api-key').value;
            
            if (!apiKey) {
                showAlert('Please enter an API key', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/add-enhanced-provider', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Enhanced USDA API added successfully! Available endpoints: ' + data.endpoints.join(', '));
                    document.getElementById('enhanced-api-key').value = '';
                    loadDataTypes();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Failed to add enhanced provider: ' + error.message, 'error');
            }
        }

        // Load available data types
        async function loadDataTypes() {
            try {
                const response = await fetch('/api/data-types');
                const data = await response.json();
                
                currentDataTypes = data.dataTypes;
                populateDataTypeCheckboxes();
                
            } catch (error) {
                showAlert('Failed to load data types: ' + error.message, 'error');
            }
        }

        function populateDataTypeCheckboxes() {
            const searchCheckboxes = document.getElementById('data-types-checkboxes');
            const browseCheckboxes = document.getElementById('browse-data-types');
            
            const checkboxHtml = currentDataTypes.map(type => `
                <div class="checkbox-item">
                    <input type="checkbox" id="dt-${type.value}" value="${type.value}">
                    <label for="dt-${type.value}">${type.label}</label>
                </div>
            `).join('');
            
            searchCheckboxes.innerHTML = checkboxHtml;
            browseCheckboxes.innerHTML = checkboxHtml.replace(/dt-/g, 'browse-dt-');
        }

        // Advanced search functionality
        async function performAdvancedSearch(pageNumber = 1) {
            const query = document.getElementById('adv-search-query').value;
            const brandOwner = document.getElementById('brand-owner').value;
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            if (!query) {
                showAlert('Please enter a search query', 'error');
                return;
            }
            
            // Get selected data types
            const selectedDataTypes = [];
            document.querySelectorAll('#data-types-checkboxes input:checked').forEach(checkbox => {
                selectedDataTypes.push(checkbox.value);
            });
            
            const searchData = {
                query: query,
                dataTypes: selectedDataTypes,
                brandOwner: brandOwner || null,
                sortBy: sortBy,
                sortOrder: sortOrder,
                pageSize: 25,
                pageNumber: pageNumber
            };
            
            try {
                showLoading('advanced-search-results');
                
                const response = await fetch('/api/advanced-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentSearchResults = data;
                    displayAdvancedSearchResults(data);
                    updateSearchStats(data);
                    createPagination('search-pagination', data, performAdvancedSearch);
                } else {
                    showAlert(data.error, 'error');
                }
                
            } catch (error) {
                showAlert('Advanced search failed: ' + error.message, 'error');
            } finally {
                hideLoading('advanced-search-results');
            }
        }

        function displayAdvancedSearchResults(data) {
            const resultsDiv = document.getElementById('advanced-search-results');
            resultsDiv.style.display = 'block';
            
            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<p>No results found.</p>';
                return;
            }
            
            const resultsHtml = data.results.map((food, index) => `
                <div class="food-item" onclick="showFoodDetails('usda_enhanced', '${food.food_id}')">
                    <div class="click-hint">Click for details</div>
                    <div class="food-name">
                        ${food.name}
                        ${getDataTypeBadge(food.data_type)}
                        <button onclick="event.stopPropagation(); addToComparison(${food.food_id}, '${food.name}')" 
                                class="btn btn-success" style="float: right; padding: 4px 8px; font-size: 12px;">
                            + Compare
                        </button>
                    </div>
                    ${food.brand ? `<div class="food-brand">${food.brand}</div>` : ''}
                    ${food.published_date ? `<div style="font-size: 0.8rem; color: #86868b;">Published: ${new Date(food.published_date).toLocaleDateString()}</div>` : ''}
                    <div style="font-size: 0.8rem; color: #86868b; margin-bottom: 4px;">
                        FDC ID: ${food.food_id}
                    </div>
                    <div class="serving-info" style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">
                        Per ${food.serving_size} ${food.serving_unit}:
                    </div>
                    <div class="nutrition-info">
                        ${formatNutritionInfo(food)}
                    </div>
                </div>
                ${index < data.results.length - 1 ? '<div class="food-separator"></div>' : ''}
            `).join('');
            
            resultsDiv.innerHTML = resultsHtml;
        }

        function updateSearchStats(data) {
            document.getElementById('total-results').textContent = data.totalHits || 0;
            document.getElementById('current-page-stat').textContent = data.currentPage || 1;
            document.getElementById('total-pages').textContent = data.totalPages || 1;
            document.getElementById('search-stats').style.display = 'flex';
        }

        // Browse foods functionality
        async function browseFoods(pageNumber = 1) {
            const selectedDataTypes = [];
            document.querySelectorAll('#browse-data-types input:checked').forEach(checkbox => {
                selectedDataTypes.push(checkbox.value);
            });
            
            if (selectedDataTypes.length === 0) {
                showAlert('Please select at least one data type to browse', 'error');
                return;
            }
            
            const pageSize = parseInt(document.getElementById('browse-page-size').value);
            
            const browseData = {
                dataTypes: selectedDataTypes,
                sortBy: 'description',
                sortOrder: 'asc',
                pageSize: pageSize,
                pageNumber: pageNumber
            };
            
            try {
                showLoading('browse-results');
                
                const response = await fetch('/api/foods-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(browseData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayBrowseResults(data);
                    createPagination('browse-pagination', data, browseFoods);
                } else {
                    showAlert(data.error, 'error');
                }
                
            } catch (error) {
                showAlert('Browse failed: ' + error.message, 'error');
            } finally {
                hideLoading('browse-results');
            }
        }

        function displayBrowseResults(data) {
            const resultsDiv = document.getElementById('browse-results');
            resultsDiv.style.display = 'block';
            
            if (!data.foods || data.foods.length === 0) {
                resultsDiv.innerHTML = '<p>No foods found.</p>';
                return;
            }
            
            const resultsHtml = data.foods.map((food, index) => `
                <div class="food-item" onclick="showFoodDetails('usda_enhanced', '${food.food_id}')">
                    <div class="click-hint">Click for details</div>
                    <div class="food-name">
                        ${food.name}
                        ${getDataTypeBadge(food.data_type)}
                        <button onclick="event.stopPropagation(); addToComparison(${food.food_id}, '${food.name}')" 
                                class="btn btn-success" style="float: right; padding: 4px 8px; font-size: 12px;">
                            + Compare
                        </button>
                    </div>
                    ${food.brand ? `<div class="food-brand">${food.brand}</div>` : ''}
                    <div style="font-size: 0.8rem; color: #86868b; margin-bottom: 4px;">
                        FDC ID: ${food.food_id}
                    </div>
                    <div class="serving-info" style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">
                        Per ${food.serving_size} ${food.serving_unit}:
                    </div>
                    <div class="nutrition-info">
                        ${formatNutritionInfo(food)}
                    </div>
                </div>
                ${index < data.foods.length - 1 ? '<div class="food-separator"></div>' : ''}
            `).join('');
            
            resultsDiv.innerHTML = resultsHtml;
        }

        // Food comparison functionality
        function addToComparison(fdcId, name) {
            if (selectedFoodsForComparison.some(food => food.id === fdcId)) {
                showAlert('Food already selected for comparison', 'error');
                return;
            }
            
            if (selectedFoodsForComparison.length >= 10) {
                showAlert('Maximum 10 foods can be compared at once', 'error');
                return;
            }
            
            selectedFoodsForComparison.push({ id: fdcId, name: name });
            updateSelectedFoodsDisplay();
            showAlert(`Added "${name}" to comparison`);
        }

        function updateSelectedFoodsDisplay() {
            const display = document.getElementById('selected-foods-display');
            const list = document.getElementById('selected-foods-list');
            
            if (selectedFoodsForComparison.length === 0) {
                display.style.display = 'none';
                return;
            }
            
            display.style.display = 'block';
            list.innerHTML = selectedFoodsForComparison.map(food => `
                <span class="selected-food-item">
                    ${food.name}
                    <span class="remove-food" onclick="removeFromComparison(${food.id})">√ó</span>
                </span>
            `).join('');
        }

        function removeFromComparison(fdcId) {
            selectedFoodsForComparison = selectedFoodsForComparison.filter(food => food.id !== fdcId);
            updateSelectedFoodsDisplay();
        }

        function clearSelectedFoods() {
            selectedFoodsForComparison = [];
            updateSelectedFoodsDisplay();
        }

        async function performComparison() {
            if (selectedFoodsForComparison.length < 2) {
                showAlert('Please select at least 2 foods to compare', 'error');
                return;
            }
            
            const fdcIds = selectedFoodsForComparison.map(food => food.id);
            await compareFoods(fdcIds);
        }

        async function compareByIds() {
            const idsInput = document.getElementById('compare-fdc-ids').value;
            if (!idsInput) {
                showAlert('Please enter FDC IDs', 'error');
                return;
            }
            
            const fdcIds = idsInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            if (fdcIds.length < 2) {
                showAlert('Please enter at least 2 valid FDC IDs', 'error');
                return;
            }
            
            await compareFood-ids(fdcIds);
        }

        async function compareFood(fdcIds) {
            try {
                const response = await fetch('/api/compare-foods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fdcIds: fdcIds
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayComparisonResults(data);
                } else {
                    showAlert(data.error, 'error');
                }
                
            } catch (error) {
                showAlert('Comparison failed: ' + error.message, 'error');
            }
        }

        function displayComparisonResults(data) {
            const resultsDiv = document.getElementById('comparison-results');
            const tableContainer = document.getElementById('comparison-table-container');
            
            resultsDiv.style.display = 'block';
            
            if (!data.foods || data.foods.length === 0) {
                tableContainer.innerHTML = '<p>No comparison data available.</p>';
                return;
            }
            
            // Create comparison table
            const commonNutrients = [
                { id: 1008, name: 'Energy (kcal)', unit: 'kcal' },
                { id: 1003, name: 'Protein', unit: 'g' },
                { id: 1004, name: 'Total Fat', unit: 'g' },
                { id: 1005, name: 'Carbohydrates', unit: 'g' },
                { id: 1079, name: 'Fiber', unit: 'g' },
                { id: 2000, name: 'Sugars', unit: 'g' },
                { id: 1093, name: 'Sodium', unit: 'mg' }
            ];
            
            let tableHtml = '<table class="comparison-table"><thead><tr><th>Nutrient</th>';
            data.foods.forEach(food => {
                tableHtml += `<th>${food.description}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            commonNutrients.forEach(nutrient => {
                tableHtml += `<tr><td>${nutrient.name} (${nutrient.unit})</td>`;
                data.foods.forEach(food => {
                    const nutrientData = food.nutrients[nutrient.id];
                    const value = nutrientData ? nutrientData.value?.toFixed(2) || '-' : '-';
                    tableHtml += `<td>${value}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
        }

        // Analytics functionality
        async function generateAnalytics() {
            // This would make requests to get counts for each data type
            // For now, we'll show placeholder functionality
            showAlert('Analytics feature would query database statistics', 'success');
        }

        // Helper functions
        function getDataTypeBadge(dataType) {
            const badges = {
                'Foundation': 'badge-foundation',
                'Branded': 'badge-branded',
                'SR Legacy': 'badge-sr-legacy',
                'Survey (FNDDS)': 'badge-survey',
                'Experimental': 'badge-experimental'
            };
            
            const badgeClass = badges[dataType] || 'badge-experimental';
            return `<span class="data-type-badge ${badgeClass}">${dataType || 'Unknown'}</span>`;
        }

        function formatNutritionInfo(food) {
            const info = [];
            if (food.calories !== null && food.calories !== undefined) info.push(`<span data-nutrient="calories">${food.calories} cal</span>`);
            if (food.protein !== null && food.protein !== undefined) info.push(`<span data-nutrient="protein">${food.protein}g protein</span>`);
            if (food.carbs !== null && food.carbs !== undefined) info.push(`<span data-nutrient="carbs">${food.carbs}g carbs</span>`);
            if (food.fat !== null && food.fat !== undefined) info.push(`<span data-nutrient="fat">${food.fat}g fat</span>`);
            if (food.sodium !== null && food.sodium !== undefined) info.push(`<span data-nutrient="sodium">${food.sodium}mg sodium</span>`);
            return info.length > 0 ? info.join(' ‚Ä¢ ') : 'Nutrition data not available';
        }

        function createPagination(containerId, data, callback) {
            const container = document.getElementById(containerId);
            const currentPage = data.currentPage || 1;
            const totalPages = data.totalPages || 1;
            
            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            let paginationHtml = `
                <button onclick="${callback.name}(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>Previous</button>
                <span class="current-page">Page ${currentPage} of ${totalPages}</span>
                <button onclick="${callback.name}(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
            `;
            
            container.innerHTML = paginationHtml;
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="loading show"><div class="spinner"></div>Loading...</div>';
            container.style.display = 'block';
        }

        function hideLoading(containerId) {
            // Loading will be replaced by actual results
        }

        function clearAdvancedSearch() {
            document.getElementById('adv-search-query').value = '';
            document.getElementById('brand-owner').value = '';
            document.getElementById('sort-by').value = 'relevance';
            document.getElementById('sort-order').value = 'asc';
            document.getElementById('nutrient-sort').value = '';
            document.getElementById('nutrient-sort-order').value = 'desc';
            document.querySelectorAll('#data-types-checkboxes input').forEach(cb => cb.checked = false);
            document.getElementById('advanced-search-results').style.display = 'none';
            document.getElementById('search-stats').style.display = 'none';
            document.getElementById('search-pagination').style.display = 'none';
        }
        
        function reorderResultsByNutrient() {
            if (!currentSearchResults || !currentSearchResults.results) return;
            
            const nutrientSort = document.getElementById('nutrient-sort').value;
            const sortOrder = document.getElementById('nutrient-sort-order').value;
            
            if (!nutrientSort) {
                // If no nutrient sorting, display original results
                displayAdvancedSearchResults(currentSearchResults);
                highlightSortedNutrient(''); // Remove highlights
                return;
            }
            
            // Create a copy of the results to sort
            const sortedResults = [...currentSearchResults.results];
            
            // Sort by the selected nutrient
            sortedResults.sort((a, b) => {
                const aValue = getNutrientValue(a, nutrientSort);
                const bValue = getNutrientValue(b, nutrientSort);
                
                // Handle null/undefined values - put them at the end
                if (aValue === null && bValue === null) return 0;
                if (aValue === null) return 1;
                if (bValue === null) return -1;
                
                // Sort based on order preference
                if (sortOrder === 'desc') {
                    return bValue - aValue; // Descending (highest first)
                } else {
                    return aValue - bValue; // Ascending (lowest first)
                }
            });
            
            // Display the sorted results
            const sortedData = {
                ...currentSearchResults,
                results: sortedResults
            };
            displayAdvancedSearchResults(sortedData);
            
            // Highlight the sorted nutrient values
            highlightSortedNutrient(nutrientSort);
            
            // Show sorting indicator
            showAlert(`Results sorted by ${nutrientSort} (${sortOrder === 'desc' ? 'highest first' : 'lowest first'})`);
        }
        
        function getNutrientValue(food, nutrientType) {
            // Map nutrient types to food properties
            switch (nutrientType) {
                case 'calories':
                    return food.calories !== null ? food.calories : null;
                case 'protein':
                    return food.protein !== null ? food.protein : null;
                case 'carbs':
                    return food.carbs !== null ? food.carbs : null;
                case 'fat':
                    return food.fat !== null ? food.fat : null;
                case 'sodium':
                    return food.sodium !== null ? food.sodium : null;
                case 'fiber':
                    return food.fiber !== null ? food.fiber : null;
                case 'sugar':
                    return food.sugar !== null ? food.sugar : null;
                default:
                    return null;
            }
        }
        
        function highlightSortedNutrient(nutrientType) {
            // Remove existing highlights
            document.querySelectorAll('.nutrient-highlight').forEach(el => {
                el.classList.remove('nutrient-highlight');
            });
            
            if (!nutrientType) return;
            
            // Add highlight to the sorted nutrient
            setTimeout(() => {
                document.querySelectorAll(`[data-nutrient="${nutrientType}"]`).forEach(el => {
                    el.classList.add('nutrient-highlight');
                });
            }, 100);
        }

        // Keep your existing showAlert and showFoodDetails functions
        function showAlert(message, type = 'success') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Food details modal functionality
        async function showFoodDetails(provider, foodId) {
            try {
                // Fetch detailed food information
                const response = await fetch(`/api/food-details/${foodId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch food details');
                }
                
                const foodData = await response.json();
                displayFoodDetailsModal(foodData);
                
            } catch (error) {
                console.error('Error fetching food details:', error);
                showAlert('Unable to load food details. Please try again.', 'error');
            }
        }
        
        function displayFoodDetailsModal(food) {
            // Store food data globally for calculations
            currentFoodData = food;
            
            // Determine default portion from food portions or use 100g
            let defaultAmount = 100;
            let defaultUnit = 'g';
            
            // Check if food has portion information
            if (food.foodPortions && food.foodPortions.length > 0) {
                const portion = food.foodPortions[0];
                defaultAmount = portion.amount || 100;
                defaultUnit = portion.modifier === 'cup' ? 'cup' : 
                             portion.modifier === 'oz' ? 'oz' :
                             portion.modifier?.includes('serving') ? 'serving' : 'g';
            }
            
            // Create and show a modal with food details
            const modalHtml = `
                <div id="food-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                " onclick="closeFoodModal()">
                    <div style="
                        background: white;
                        padding: 24px;
                        border-radius: 12px;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                        margin: 20px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    " onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="margin: 0; color: #333;">${food.description || 'Food Details'}</h2>
                            <button onclick="closeFoodModal()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #666;
                            ">√ó</button>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 16px;">
                            <strong>FDC ID:</strong> ${food.fdcId}<br>
                            <strong>Data Type:</strong> ${food.dataType || 'Unknown'}<br>
                            ${food.brandOwner ? `<strong>Brand:</strong> ${food.brandOwner}<br>` : ''}
                            ${food.publishedDate ? `<strong>Published:</strong> ${new Date(food.publishedDate).toLocaleDateString()}<br>` : ''}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h3 style="color: #007aff; margin: 0 0 12px 0;">Portion Size Calculator</h3>
                            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Amount:</label>
                                    <input type="number" id="portion-amount" value="${defaultAmount}" min="0.1" step="0.1" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                           onchange="recalculateNutrients()">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Unit:</label>
                                    <select id="portion-unit" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                            onchange="recalculateNutrients()">
                                        <option value="g" ${defaultUnit === 'g' ? 'selected' : ''}>grams (g)</option>
                                        <option value="oz" ${defaultUnit === 'oz' ? 'selected' : ''}>ounces (oz)</option>
                                        <option value="lb" ${defaultUnit === 'lb' ? 'selected' : ''}>pounds (lb)</option>
                                        <option value="kg" ${defaultUnit === 'kg' ? 'selected' : ''}>kilograms (kg)</option>
                                        <option value="cup" ${defaultUnit === 'cup' ? 'selected' : ''}>cup</option>
                                        <option value="tbsp" ${defaultUnit === 'tbsp' ? 'selected' : ''}>tablespoon</option>
                                        <option value="tsp" ${defaultUnit === 'tsp' ? 'selected' : ''}>teaspoon</option>
                                        <option value="serving" ${defaultUnit === 'serving' ? 'selected' : ''}>serving</option>
                                    </select>
                                </div>
                                <div style="flex: 0;">
                                    <button onclick="recalculateNutrients()" style="
                                        background: #007aff;
                                        color: white;
                                        border: none;
                                        padding: 10px 16px;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        margin-top: 20px;
                                    ">Calculate</button>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                <strong>Note:</strong> Nutritional values are calculated per 100g. Portion calculator adjusts values proportionally.
                            </div>
                        </div>
                        <div id="nutrients-section">
                            <h3 style="color: #007aff; margin-bottom: 12px;">Nutritional Information</h3>
                            <div id="nutrients-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <!-- Will be populated by recalculateNutrients() -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Trigger initial calculation with default values
            setTimeout(() => {
                recalculateNutrients();
            }, 100);
        }
        
        function formatNutrientsForModal(nutrients) {
            if (!nutrients || nutrients.length === 0) {
                return '<p style="grid-column: 1/-1; color: #666;">No nutritional data available</p>';
            }
            
            // Show most important nutrients first
            const importantNutrients = [1008, 1003, 1004, 1005, 1079, 2000, 1093, 1087, 1089];
            const sortedNutrients = nutrients.sort((a, b) => {
                const aIndex = importantNutrients.indexOf(a.nutrient?.id || a.nutrientId);
                const bIndex = importantNutrients.indexOf(b.nutrient?.id || b.nutrientId);
                if (aIndex === -1 && bIndex === -1) return 0;
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            return sortedNutrients.slice(0, 20).map(nutrient => {
                const name = nutrient.nutrient?.name || nutrient.name || 'Unknown';
                const amount = nutrient.amount || nutrient.value || 0;
                const unit = nutrient.nutrient?.unitName || nutrient.unit || '';
                
                return `
                    <div style="padding: 8px; border: 1px solid #eee; border-radius: 4px;">
                        <strong>${name}</strong><br>
                        <span style="color: #007aff;">${amount.toFixed(2)} ${unit}</span>
                    </div>
                `;
            }).join('');
        }
        
        function closeFoodModal() {
            const modal = document.getElementById('food-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Global variable to store original food data
        let currentFoodData = null;
        
        // Unit conversion factors (everything converted to grams)
        const unitConversions = {
            'g': 1,
            'kg': 1000,
            'oz': 28.3495,
            'lb': 453.592,
            'cup': 240,      // Approximate for liquids/general
            'tbsp': 15,      // Approximate
            'tsp': 5,        // Approximate
            'serving': 100   // Default serving size
        };
        
        function recalculateNutrients() {
            if (!currentFoodData) return;
            
            const amount = parseFloat(document.getElementById('portion-amount').value) || 100;
            const unit = document.getElementById('portion-unit').value;
            
            // Convert input to grams
            const gramsAmount = amount * unitConversions[unit];
            
            // Calculate multiplier (USDA data is per 100g)
            const multiplier = gramsAmount / 100;
            
            // Update the display
            updateNutrientsDisplay(currentFoodData.foodNutrients || [], multiplier, amount, unit);
        }
        
        function updateNutrientsDisplay(nutrients, multiplier, displayAmount, displayUnit) {
            const nutrientsList = document.getElementById('nutrients-list');
            if (!nutrientsList) return;
            
            if (!nutrients || nutrients.length === 0) {
                nutrientsList.innerHTML = '<p style="grid-column: 1/-1; color: #666;">No nutritional data available</p>';
                return;
            }
            
            // Show most important nutrients first
            const importantNutrients = [1008, 1003, 1004, 1005, 1079, 2000, 1093, 1087, 1089];
            const sortedNutrients = nutrients.sort((a, b) => {
                const aIndex = importantNutrients.indexOf(a.nutrient?.id || a.nutrientId);
                const bIndex = importantNutrients.indexOf(b.nutrient?.id || b.nutrientId);
                if (aIndex === -1 && bIndex === -1) return 0;
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            const nutrientsHtml = sortedNutrients.slice(0, 20).map(nutrient => {
                const name = nutrient.nutrient?.name || nutrient.name || 'Unknown';
                const originalAmount = nutrient.amount || nutrient.value || 0;
                const calculatedAmount = originalAmount * multiplier;
                const unit = nutrient.nutrient?.unitName || nutrient.unit || '';
                
                return `
                    <div style="padding: 8px; border: 1px solid #eee; border-radius: 4px; position: relative;">
                        <strong>${name}</strong><br>
                        <span style="color: #007aff; font-size: 16px;">${calculatedAmount.toFixed(2)} ${unit}</span>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">
                            per ${displayAmount} ${displayUnit}
                        </div>
                        ${multiplier !== 1 ? `
                            <div style="font-size: 10px; color: #aaa;">
                                (orig: ${originalAmount.toFixed(2)} ${unit}/100g)
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            nutrientsList.innerHTML = nutrientsHtml;
        }
    </script>
</body>
</html>